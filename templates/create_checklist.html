{% extends "base.html" %}
{% block title %}Создать чеклист{% endblock %}
{% block content %}
<h2 style="margin-top:0;">Создание чеклиста</h2>
<div class="checklist-content"
     style="background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
    {% if checklist.tasks %}
    {% set colors = ["#FFB6C1", "#FFDEAD", "#E6E6FA", "#F5DEB3", "#FFFACD", "#E0FFFF", "#F0FFF0"] %}
    {% for task in checklist.tasks %}
    <div class="location-block"
         style="background-color: {{ colors[loop.index0 % colors|length] }}; border-radius: 8px; padding: 10px; margin-bottom: 10px;">
        <div class="location-header" style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">
            Локация: {{ task.location if task.location else 'Не указана' }}
        </div>
        <ul>
            {% for obj in task.objects %}
            <li>{{ obj.name }} ({{ obj.cr_code }})</li>
            {% endfor %}
        </ul>
        <div style="margin-top: 10px;">
            <a href="/edit_location/{{ loop.index0 }}" class="preserve-user"
               style="padding: 8px 12px; background-color: #007bff; color: white; border: none; border-radius: 8px; text-decoration: none; margin-right: 5px;">
                Редактировать
            </a>
            <a href="/delete_location/{{ loop.index0 }}" class="preserve-user"
               style="padding: 8px 12px; background-color: #dc3545; color: white; border: none; border-radius: 8px; text-decoration: none;">
                Удалить
            </a>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <p>Чеклист пуст. Добавьте локацию.</p>
    {% endif %}
</div>

<div class="checklist-actions"
     style="background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px;">
    <!-- Кнопка "Добавить локацию" -->
    <form method="post" action="/select_location">
        <!-- Передаём чеклист как JSON в скрытом поле -->
        <input type="hidden" name="checklist_obj" value='{{ checklist.json() | safe }}'>
        <button type="submit"
                style="padding: 10px 15px; background-color: #28a745; color: white; border: none; border-radius: 8px;">
            Добавить локацию
        </button>
    </form>

    <!-- Форма для сохранения чеклиста -->
    <form method="post" action="/save_checklist" style="display: flex; align-items: center; gap: 10px;">
        <!-- Передаём чеклист как JSON в скрытом поле -->
        <input type="hidden" name="checklist_obj" value='{{ checklist.json() | safe }}'>
        <label for="selected_user"
               style="padding: 8px 12px; background-color: #f68b20; color: #ffffff; border-radius: 8px;">
            <strong>Выберите пользователя:</strong>
        </label>
        <select name="selected_user" id="selected_user" required
                style="height: 40px; border-radius: 8px; padding: 5px;">
            <option value="">-- Выберите пользователя --</option>
            {% for user in users %}
            <option value="{{ user.username }}" {% if user.username== selected_user %}selected{% endif %}>
                {{ user.username }}
            </option>
            {% endfor %}
        </select>

        <button type="submit"
                style="padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 8px;">
            Сохранить чеклист
        </button>
    </form>
</div>

<script>
    // При изменении выбранного пользователя сохраняем значение в localStorage
    const selectedUserSelect = document.getElementById("selected_user");
    selectedUserSelect.addEventListener('change', function () {
        localStorage.setItem("selected_user", this.value);
    });

    // При загрузке страницы восстанавливаем выбранного пользователя из localStorage
    window.addEventListener('load', function () {
        const storedUser = localStorage.getItem("selected_user");
        if (storedUser) {
            selectedUserSelect.value = storedUser;
        }
    });
</script>
{% endblock %}