{% extends "base.html" %}
{% block title %}Выбор объектов{% endblock %}
{% block content %}
  <h2>Выберите объекты для локации: {{ location }}</h2>
  {% if error %}
    <p style="color: red;">{{ error }}</p>
  {% endif %}
  <form id="objectsForm" method="post" action="/create_checklist">
    <!-- Передаём чеклист и task -->
    <input type="hidden" name="checklist_obj" value='{{ checklist.json() | safe }}'>
    <input type="hidden" name="task_obj" value='{{ task.json() | safe }}'>
    <!-- Скрытое поле для выбранных объектов, которое заполнит JS -->
    <input type="hidden" name="selected_objects" id="selectedObjects" value="[]">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 20px;">
      {% for obj in objects %}
        <label style="display: block; background-color: #f0f8ff; padding: 10px; border-radius: 8px;">
          <input type="checkbox" name="obj" value='{{ obj | tojson | safe }}'
                 {% if obj.cr_code in preselected_codes %}checked{% endif %}>
          {{ obj.name }} ({{ obj.cr_code }})
        </label>
      {% endfor %}
    </div>
    <br>
    <button type="button" onclick="submitObjects()" style="padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 8px;">
      Добавить
    </button>
  </form>
  <br>
  <button onclick="window.history.back()" style="padding: 10px; background-color: #6c757d; color: white; border: none; border-radius: 8px;">
    Назад
  </button>
  <script>
    function submitObjects() {
      const checkboxes = document.querySelectorAll('input[name="obj"]:checked');
      let selected = [];
      checkboxes.forEach(cb => {
        try {
          selected.push(JSON.parse(cb.value));
        } catch (e) {
          console.error(e);
        }
      });
      document.getElementById("selectedObjects").value = JSON.stringify(selected);
      document.getElementById("objectsForm").submit();
    }
  </script>
{% endblock %}